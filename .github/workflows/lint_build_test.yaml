name: Lint, Build & Test
on:
  push:
    branches:
    - main
  pull_request:
    branches:
    - main
defaults:
  run:
    shell: bash

jobs:
  Linting:
    name: Lint Code Base
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup
      run: |
        sudo apt-get update && sudo apt-get install -y black clang-format cppcheck libxml2-utils

    - name: Set up Python
      uses: actions/setup-python@v4

    - name: Install and Run pre-commit
      uses: pre-commit/action@v3.0.1
      with:
        extra_args: --all-files

  build-and-test:
    needs: Linting
    strategy:
      matrix:
        setup:
        - rosdistro: jazzy
          os: ubuntu-24.04
        - rosdistro: kilted
          os: ubuntu-24.04
        - rosdistro: rolling
          os: ubuntu-latest
    runs-on: ${{ matrix.setup.os }}
    container:
      image: ros:${{ matrix.setup.rosdistro }}-ros-base
    steps:
    - name: install build tools
      run: |
        sudo apt-get update
        # Added lcov and curl (needed for codecov upload)
        sudo apt-get install -y ros-dev-tools lcov curl

    - uses: actions/checkout@v4
      with:
        path: src/repo

    - name: rosdep
      run: |
        rosdep update --rosdistro ${{ matrix.setup.rosdistro }} --include-eol-distros
        rosdep install -y --from-paths src --ignore-src --rosdistro ${{ matrix.setup.rosdistro }}

    - name: build
      run: |
        source /opt/ros/${{ matrix.setup.rosdistro }}/setup.bash
        # Added coverage flags here
        colcon build \
          --symlink-install \
          --cmake-args -DENABLE_COVERAGE_TESTING=ON -DCMAKE_BUILD_TYPE=Debug

    - name: test
      run: |
        source /opt/ros/${{ matrix.setup.rosdistro }}/setup.bash
        colcon test
        colcon test-result --verbose

    - name: Generate Coverage Report
      run: |
        # 1. Capture data, tolerating gcc 13 line mismatches and unexecuted block noise
        lcov \
          --capture \
          --directory build \
          --output-file coverage.info \
          --ignore-errors mismatch,gcov \
          --rc geninfo_unexecuted_blocks=1

        # 2. Remove system files, test files, install space and gtest objects; ignore unused excludes
        lcov \
          --remove coverage.info \
          '/usr/*' '*/test/*' '*/install/*' '*/gtest/*' \
          --output-file coverage_cleaned.info \
          --ignore-errors unused

        # 3. List summary for debugging logs
        lcov --list coverage_cleaned.info

    - name: Upload to Codecov
      uses: codecov/codecov-action@v5
      with:
        files: coverage_cleaned.info
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}
